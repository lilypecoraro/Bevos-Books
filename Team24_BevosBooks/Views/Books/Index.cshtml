@model IEnumerable<Team24_BevosBooks.Models.Book>

@{
    ViewData["Title"] = "Books";

    // Count of records returned (filtered)
    int resultCount = Model?.Count() ?? 0;
    // Total count of all books in database (set in controller)
    int totalCount = ViewBag.TotalCount ?? resultCount;

    // Map of BookID -> effective price (from controller)
    var effectiveMap = ViewBag.EffectivePrices as IDictionary<int, decimal> ?? new Dictionary<int, decimal>();
}

<h2 class="mb-4">Browse Books</h2>

<form asp-action="Index" method="get" class="mb-3">
    <div class="row g-2 align-items-center">
        <div class="col-md-3">
            <input type="text" name="searchString" value="@ViewBag.SearchString"
                   class="form-control" placeholder="Search by title, author, genre, or number..." />
        </div>
        <div class="col-md-3">
            <select name="genreId" asp-items="ViewBag.GenreID" class="form-select">
                <option value="0">All Genres</option>
            </select>
        </div>
        <div class="col-md-3">
            <select name="sortOrder" class="form-select">
                <option value="title" selected="@("title" == ViewBag.SortOrder)">Title (A-Z)</option>
                <option value="author" selected="@("author" == ViewBag.SortOrder)">Author (A-Z)</option>
                <option value="newest" selected="@("newest" == ViewBag.SortOrder)">Newest</option>
                <option value="oldest" selected="@("oldest" == ViewBag.SortOrder)">Oldest</option>
                <option value="priceAsc" selected="@("priceAsc" == ViewBag.SortOrder)">Price (Low → High)</option>
                <option value="priceDesc" selected="@("priceDesc" == ViewBag.SortOrder)">Price (High → Low)</option>
                <option value="rating" selected="@("rating" == ViewBag.SortOrder)">Highest Rated</option>
                <option value="popularity" selected="@("popularity" == ViewBag.SortOrder)">Most Popular</option>
            </select>
        </div>
        <div class="col-md-2 form-check">
            <input type="checkbox" name="inStockOnly" value="true"
                   class="form-check-input" id="inStockOnly"
                   @(ViewBag.InStockOnly ? "checked" : "") />
            <label class="form-check-label" for="inStockOnly">In Stock Only</label>
        </div>
        <div class="col-md-1">
            <button type="submit" class="btn btn-primary w-100">Search</button>
        </div>
        <div class="col-md-2">
            <!-- Button to reset filters and show all books -->
            <a asp-action="Index" class="btn btn-secondary w-100">Show All Books</a>
        </div>
    </div>
</form>

<!-- Record count -->
<div class="mb-3">
    <span class="fw-bold">
        Showing @resultCount of @totalCount total books
    </span>
</div>

<table class="table table-bordered table-striped table-hover bg-white text-dark">
    <thead class="table-dark">
        <tr>
            <th>Title</th>
            <th>Authors</th>
            <th>Unique Number</th>
            <th>Stock Status</th>
            <th>Rating</th>
            <th>Price</th>
            <th>Details</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var book in Model)
        {
            // Compute average rating from approved reviews
            var avgRating = book.Reviews != null && book.Reviews.Any(r => r.DisputeStatus == "Approved")
                ? book.Reviews.Where(r => r.DisputeStatus == "Approved").Average(r => r.Rating)
                : 0;

            // Effective price from controller; fall back to Book.Price
            decimal effectivePrice = effectiveMap.TryGetValue(book.BookID, out var ep) ? ep : book.Price;
            bool hasItemDiscount = effectivePrice < book.Price;

<tr onclick="window.location='@Url.Action("Details", "Books", new { id = book.BookID })'" style="cursor:pointer;">
    <td>
        <a asp-action="Details" asp-route-id="@book.BookID" class="text-dark">
            @book.Title
        </a>
    </td>
    <td>@book.Authors</td>
    <td>@book.BookNumber</td>
    <td>
        @(
            book.BookStatus == "Discontinued"
            ? "Discontinued"
            : (book.InventoryQuantity > 0 ? "In Stock" : "Out of Stock")
        )
    </td>
    <td>
        @(avgRating > 0 ? $"{avgRating:0.0}" : "No Ratings")
    </td>
    <td>
        @if (hasItemDiscount)
        {
            <div>
                <s class="text-dark">@book.Price.ToString("C")</s><br />
                <span class="text-success fw-bold">@effectivePrice.ToString("C")</span>
            </div>
        }
        else
        {
            @book.Price.ToString("C")
        }
    </td>
    <td>
        <a asp-action="Details" asp-route-id="@book.BookID"
           class="btn btn-sm btn-outline-primary">View</a>
    </td>
</tr>

        }
    </tbody>
</table>
