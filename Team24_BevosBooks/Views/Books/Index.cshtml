@model IEnumerable<Team24_BevosBooks.Models.Book>
@using Team24_BevosBooks.Models

@{
    ViewData["Title"] = "Book Catalog";

    var sortOrder = ViewBag.SortOrder as string ?? "title";
    bool inStockOnly = ViewBag.InStockOnly ?? false;
    string searchString = ViewBag.SearchString as string ?? "";
    int selectedGenreId = ViewBag.SelectedGenreId ?? 0;
}

<h2 class="mt-3 mb-3">Book Catalog</h2>

<!-- ADMIN: Add New Book -->
@if (User.IsInRole("Admin"))
{
    <div class="d-flex justify-content-end mb-3">
        <a asp-action="Create" class="btn btn-primary">
            + Add New Book
        </a>
    </div>
}

<!-- SEARCH + FILTER BAR -->
<form asp-action="Index" method="get" class="row g-3 mb-4">

    <!-- SEARCH BOX -->
    <div class="col-md-4">
        <label class="form-label">Search</label>
        <input type="text"
               name="searchString"
               value="@searchString"
               class="form-control"
               placeholder="Title, author, genre, book #..." />
    </div>

    <!-- GENRE FILTER -->
    <div class="col-md-3">
        <label class="form-label">Genre</label>
        <select name="genreId" class="form-select" asp-items="ViewBag.GenreID">
            <option value="0">All Genres</option>
        </select>
    </div>

    <!-- SORT OPTIONS -->
    <div class="col-md-3">
        <label class="form-label">Sort By</label>
        <select name="sortOrder" class="form-select">

            <option value="title" selected="@(sortOrder == "title")">Title</option>
            <option value="author" selected="@(sortOrder == "author")">Author</option>
            <option value="newest" selected="@(sortOrder == "newest")">Newest</option>
            <option value="oldest" selected="@(sortOrder == "oldest")">Oldest</option>
            <option value="priceAsc" selected="@(sortOrder == "priceAsc")">Price (Low → High)</option>
            <option value="priceDesc" selected="@(sortOrder == "priceDesc")">Price (High → Low)</option>

            <!-- Placeholder sort fields (until reviews are implemented) -->
            <option value="popularity" selected="@(sortOrder == "popularity")">Popularity</option>
            <option value="highestRated" selected="@(sortOrder == "highestRated")">Highest Rated</option>

        </select>
    </div>

    <!-- IN-STOCK ONLY -->
    <div class="col-md-2 d-flex align-items-end">
        <div class="form-check me-2">
            <input class="form-check-input"
                   type="checkbox"
                   name="inStockOnly"
                   value="true"
                   @(inStockOnly ? "checked" : "") />
            <label class="form-check-label">In Stock Only</label>
        </div>

        <button type="submit" class="btn btn-primary ms-2">Search</button>
    </div>

</form>


<!-- NO RESULTS MESSAGE -->
@if (!Model.Any())
{
    <div class="alert alert-info">
        No books match your search criteria.
    </div>
}
else
{
    <table class="table table-striped table-hover align-middle">
        <thead class="table-dark">
            <tr>
                <th>Book #</th>
                <th>Title</th>
                <th>Authors</th>
                <th>Genre</th>
                <th>Price</th>
                <th>Publish Date</th>
                <th>Inventory</th>
                <th>Status</th>
                <th class="text-center">Actions</th>
            </tr>
        </thead>

        <tbody>
            @foreach (var item in Model)
            {
                bool canAdd = item.BookStatus == "Active" && item.InventoryQuantity > 0;

                <tr>
                    <td>@item.BookNumber</td>
                    <td>@item.Title</td>
                    <td>@item.Authors</td>
                    <td>@item.Genre?.GenreName</td>
                    <td>@item.Price.ToString("c")</td>
                    <td>@item.PublishDate.ToShortDateString()</td>
                    <td>@item.InventoryQuantity</td>
                    <td>@item.BookStatus</td>

                    <td class="text-nowrap text-center">

                        <!-- DETAILS BUTTON -->
                        <a asp-action="Details"
                           asp-route-id="@item.BookID"
                           class="btn btn-sm btn-outline-primary me-1">
                            Details
                        </a>

                        <!-- CUSTOMER: Add to Cart -->
                        @if (User.IsInRole("Customer"))
                        {
                            <a asp-controller="Orders"
                               asp-action="AddToCart"
                               asp-route-id="@item.BookID"
                               class="btn btn-sm btn-success me-1 @(canAdd ? "" : "disabled")">
                                Add to Cart
                            </a>
                        }

                        <!-- ADMIN: Edit + Discontinue -->
                        @if (User.IsInRole("Admin"))
                        {
                            <a asp-action="Edit"
                               asp-route-id="@item.BookID"
                               class="btn btn-sm btn-outline-warning me-1">
                                Edit
                            </a>

                            <a asp-action="Discontinue"
                               asp-route-id="@item.BookID"
                               class="btn btn-sm btn-outline-danger">
                                Discontinue
                            </a>
                        }

                    </td>
                </tr>
            }
        </tbody>
    </table>
}