@model Team24_BevosBooks.Models.Book

@{
    ViewData["Title"] = "Book Details";

    var reviews = Model.Reviews ?? new List<Review>();
}

<h2 class="mt-3 mb-3">Book Details</h2>

<div class="row">

    <!-- LEFT SIDE -->
    <div class="col-md-8">

        <dl class="row">
            <dt class="col-sm-3">Title</dt>
            <dd class="col-sm-9">@Model.Title</dd>

            <dt class="col-sm-3">Authors</dt>
            <dd class="col-sm-9">@Model.Authors</dd>

            <dt class="col-sm-3">Genre</dt>
            <dd class="col-sm-9">@Model.Genre?.GenreName</dd>

            <dt class="col-sm-3">Book #</dt>
            <dd class="col-sm-9">@Model.BookNumber</dd>

            <dt class="col-sm-3">Price</dt>
            <dd class="col-sm-9">@Model.Price.ToString("c")</dd>

            <dt class="col-sm-3">Publish Date</dt>
            <dd class="col-sm-9">@Model.PublishDate.ToShortDateString()</dd>

            <dt class="col-sm-3">Description</dt>
            <dd class="col-sm-9">@Model.Description</dd>

            <dt class="col-sm-3">Inventory</dt>
            <dd class="col-sm-9">@Model.InventoryQuantity</dd>

            <dt class="col-sm-3">Status</dt>
            <dd class="col-sm-9">@Model.BookStatus</dd>
        </dl>


        <!-- =============================== -->
        <!-- OTHER CARTS FEATURE -->
        <!-- =============================== -->
        @if (ViewBag.CartsContaining > 0)
        {
            <div class="alert alert-warning mt-3">
                <strong>@ViewBag.CartsContaining</strong>
                @(ViewBag.CartsContaining == 1 ? "other customer has" : "other customers have")
                this book in their cart right now.
            </div>
        }

        <hr />

        <!-- =============================== -->
        <!-- REVIEWS SECTION -->
        <!-- =============================== -->
        <h4>Reviews</h4>

        @if (Model.Reviews == null || !Model.Reviews.Any())
        {
            <p class="text-muted">No approved reviews yet.</p>
        }
        else
        {
            <ul class="list-group mb-4">
                @foreach (var r in Model.Reviews)
                {
                    <li class="list-group-item">
                        <strong>@r.Rating ★</strong><br />
                        @r.ReviewText
                        <br />
                        <small class="text-muted">
                            — @r.Reviewer.FirstName @r.Reviewer.LastName
                        </small>
                    </li>
                }
            </ul>
        }


        <!-- =============================== -->
        <!-- WRITE REVIEW BUTTON -->
        <!-- =============================== -->
        @if (User.Identity.IsAuthenticated && User.IsInRole("Customer"))
        {
            if (ViewBag.CanReview == true)
            {
                <a asp-controller="Reviews"
                   asp-action="Submit"
                   asp-route-bookId="@Model.BookID"
                   class="btn btn-outline-primary mt-3">
                    Write a Review
                </a>
            }
            else if (ViewBag.HasReviewed == true)
            {
                <p class="text-muted mt-2"><em>You have already reviewed this book.</em></p>
            }
            else
            {
                <p class="text-muted mt-2"><em>You can only review books you have purchased.</em></p>
            }
        }

    </div>

    <!-- RIGHT SIDE: ADD TO CART -->
    <div class="col-md-4">
        <div class="card shadow-sm">
            <div class="card-body">
                <h5 class="card-title">@Model.Title</h5>

                <p class="card-text mb-3">
                    <strong>Price:</strong> @Model.Price.ToString("c") <br />
                    <strong>Availability:</strong>

                    @if (Model.BookStatus == "Discontinued")
                    {
                        <span class="text-danger">Not Available (Discontinued)</span>
                    }
                    else if (Model.InventoryQuantity > 0)
                    {
                        <span class="text-success">In Stock</span>
                    }
                    else
                    {
                        <span class="text-warning">Out of Stock</span>
                    }
                </p>

                @if (Model.BookStatus != "Discontinued" && Model.InventoryQuantity > 0)
                {
                    if (User.Identity.IsAuthenticated && User.IsInRole("Customer"))
                    {
                        <a asp-controller="Orders"
                           asp-action="AddToCart"
                           asp-route-id="@Model.BookID"
                           class="btn btn-primary w-100 mb-2">
                            Add to Cart
                        </a>
                    }
                    else
                    {
                        <a asp-controller="Account"
                           asp-action="Login"
                           asp-route-returnUrl="@Url.Action("Details", "Books", new { id = Model.BookID })"
                           class="btn btn-primary w-100 mb-2">
                            Log in to Add to Cart
                        </a>
                    }
                }
                else
                {
                    <button class="btn btn-secondary w-100 mb-2" disabled>Not Available</button>
                }

                <a asp-action="Index" class="btn btn-link w-100 mt-1">Back to List</a>
            </div>
        </div>
    </div>
</div>