@model Team24_BevosBooks.Models.ViewModels.CheckoutViewModel

@{
    ViewData["Title"] = "Checkout";
}

<h2 class="mt-3 mb-3">Checkout</h2>

@if (!Model.Order.OrderDetails.Any())
{
    <div class="alert alert-warning">
        Your shopping cart is empty. You cannot check out until items are added.
    </div>
    <a asp-controller="Books" asp-action="Index" class="btn btn-primary">Browse Books</a>
}
else
{
    <!-- SINGLE FORM WRAPS BOTH COLUMNS -->
    <form asp-action="Checkout" method="post" id="checkoutForm">
        @Html.AntiForgeryToken()

        <div class="row checkout-page">

            <!-- LEFT COLUMN -->
            <div class="col-md-7">

                <!-- PAYMENT CARD BLOCK -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Select Payment Method</h5>
                    </div>

                    <div class="card-body">
                        @if (!Model.Cards.Any())
                        {
                            <p>You have no saved credit cards.</p>
                            <a asp-controller="Account" asp-action="AddCard"
                               class="btn btn-primary btn-sm">Add a Credit Card</a>
                        }
                        else
                        {
                            <div class="mb-3">
                                <label class="form-label"><strong>Choose a credit card:</strong></label>

                                <!-- Binds to SelectedCardID in the POST -->
                                <select asp-for="SelectedCardID" class="form-select" required>
                                    <option value="">-- Select Card --</option>

                                    @foreach (var c in Model.Cards)
                                    {
                                        string last4 = c.CardNumber[^4..];
                                        <option value="@c.CardID">@c.CardType •••• @last4</option>
                                    }
                                </select>

                                <span asp-validation-for="SelectedCardID" class="text-danger"></span>
                            </div>

                            <!-- Add another card button - black text -->
                            <a asp-controller="Account" asp-action="AddCard"
                               class="btn btn-outline-secondary btn-sm mb-2 add-card-btn">
                                Add another card
                            </a>
                        }
                    </div>
                </div>

                <!-- COUPON BLOCK -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5>Coupon Code</h5>
                    </div>

                    <div class="card-body">
                        <div class="input-group">
                            <!-- Binds to CouponCode in the POST -->
                            <input asp-for="CouponCode" class="form-control" placeholder="Enter coupon code" />
                            <!-- Same action, same form — coupon applied when order is placed -->
                            <button type="submit" class="btn btn-primary">
                                Apply &amp; Place Order
                            </button>
                        </div>

                        <span asp-validation-for="CouponCode" class="text-danger"></span>

                        @if (ViewBag.CheckoutMessage != null)
                        {
                            <div class="alert alert-info mt-2">@ViewBag.CheckoutMessage</div>
                        }
                    </div>
                </div>

            </div> <!-- END LEFT COLUMN -->
            <!-- RIGHT COLUMN -->
            <div class="col-md-5">

                <div class="card">
                    <div class="card-header">
                        <h5>Order Summary</h5>
                    </div>

                    <div class="card-body">
                        <p><strong>Subtotal:</strong> @Model.Subtotal.ToString("c")</p>
                        <p><strong>Shipping:</strong> @Model.Shipping.ToString("c")</p>
                        <p class="fs-4"><strong>Total:</strong> @Model.Total.ToString("c")</p>

                        <!-- This button also posts the same form -->
                        <button type="submit"
                                class="btn btn-success w-100"
                                @(Model.Cards.Any() ? "" : "disabled")>
                            Place Order
                        </button>
                    </div>
                </div>

            </div> <!-- END RIGHT COLUMN -->

        </div> <!-- END ROW -->
    </form>
}

@section Styles {
    <style>
        .checkout-page,
        .checkout-page h5,
        .checkout-page p,
        .checkout-page label,
        .checkout-page strong,
        .checkout-page .card-header,
        .checkout-page .card-body {
            color: #000 !important;
        }

            .checkout-page .form-control,
            .checkout-page .form-select,
            .checkout-page .form-label {
                color: #000 !important;
                background-color: #fff !important;
                border: 1px solid #ccc !important;
            }

                .checkout-page .form-control::placeholder {
                    color: #666 !important;
                }

        /* Make Add Another Card button text black */
        .add-card-btn {
            color: #000 !important;
            border-color: #000 !important;
            background-color: rgba(255,255,255,0.85) !important;
            font-weight: 600 !important;
        }

            .add-card-btn:hover {
                background-color: #fff !important;
                color: #000 !important;
                border-color: #000 !important;
            }
    </style>
}